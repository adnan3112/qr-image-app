<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Secure Image</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        text-align: center;
        padding: 30px;
      }
      input,
      button {
        margin: 10px;
        padding: 10px;
      }
      img {
        max-width: 100%;
        margin-top: 20px;
        display: none;
        border-radius: 10px;
      }
      #error {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>üîì Unlock Image</h2>
    <p>Enter password to view the protected image</p>

    <input type="password" id="pwd" placeholder="Enter Password" />
    <button onclick="unlockImage()">Unlock</button>

    <p id="error"></p>
    <img id="protectedImg" />

    <script>
      const backendUrl = "https://qr-image-app.onrender.com"; // Render backend

      function unlockImage() {
        const pwd = document.getElementById("pwd").value.trim();
        const params = new URLSearchParams(window.location.hash.slice(1));
        const correctPwd = params.get("pwd");
        const fileName = params.get("file");

        if (!pwd || !fileName) {
          document.getElementById("error").textContent =
            "‚ùå Missing password or file info.";
          return;
        }

        if (pwd !== correctPwd) {
          document.getElementById("error").textContent = "‚ùå Wrong password!";
          return;
        }

        // If password matches, request a signed download URL from backend
        fetch(`${backendUrl}/download?fileName=${encodeURIComponent(fileName)}`)
          .then((res) => res.json())
          .then((data) => {
            if (data.downloadUrl) {
              document.getElementById("protectedImg").src = data.downloadUrl;
              document.getElementById("protectedImg").style.display = "block";
              document.getElementById("error").textContent = "";
            } else {
              document.getElementById("error").textContent =
                "‚ùå Could not fetch image.";
            }
          })
          .catch((err) => {
            console.error(err);
            document.getElementById("error").textContent =
              "‚ùå Error fetching image.";
          });
      }
    </script>
  </body>
</html>
