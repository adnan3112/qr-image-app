<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Secure Image</title>
    <style>
      body {
        font-family: Arial;
        text-align: center;
        padding: 30px;
      }
      input,
      button {
        margin: 10px;
        padding: 10px;
      }
      img {
        max-width: 100%;
        margin-top: 20px;
        display: none;
        border-radius: 10px;
      }
      #error {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>üîì Unlock Image</h2>
    <p>Enter password to view the protected image</p>

    <input type="password" id="pwd" placeholder="Enter Password" />
    <button onclick="unlockImage()">Unlock</button>

    <p id="error"></p>
    <img id="protectedImg" />

    <script>
      const backendUrl = "https://qr-image-app.onrender.com"; // your Render backend

      let selectedFileName = null;

      // On page load, read file parameter from URL hash and assign to selectedFileName
      window.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.hash.slice(1));
        selectedFileName = params.get("file");
      });

      function unlockImage() {
        const pwd = document.getElementById("pwd").value.trim();

        if (!pwd || !selectedFileName) {
          document.getElementById("error").textContent =
            "‚ùå Missing password or file info.";
          return;
        }

        // Request a signed download URL from backend
        fetch(`${backendUrl}/download?fileName=${encodeURIComponent(selectedFileName)}`)
          .then((res) => res.json())
          .then((data) => {
            if (data.downloadUrl) {
              const img = document.getElementById("protectedImg");
              img.src = data.downloadUrl;
              img.style.display = "block";
              document.getElementById("error").textContent = "";
            } else {
              document.getElementById("error").textContent =
                "‚ùå Could not fetch image.";
            }
          })
          .catch((err) => {
            console.error(err);
            document.getElementById("error").textContent =
              "‚ùå Error fetching image.";
          });
      }
    </script>
  </body>
</html>
